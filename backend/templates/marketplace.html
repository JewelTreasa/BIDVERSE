{% extends "base.html" %}

{% block content %}
<section class="section marketplace" style="padding: 100px 0; background: #f8fafc;">
    <div class="container">
        <div class="section-header" style="text-align: center; margin-bottom: 60px;">
            <h1
                style="font-family: 'Playfair Display', serif; font-size: 42px; margin-bottom: 15px; color: var(--text-dark);">
                Marketplace</h1>
            <p style="color: #64748b; font-size: 18px;">Stay updated with real-time agricultural auctions</p>

            <div class="session-status"
                style="display: inline-flex; align-items: center; gap: 10px; padding: 8px 16px; background: white; border-radius: 30px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                <span class="status-indicator {{ session_info.session|lower }}"
                    style="width: 10px; height: 10px; border-radius: 50%;"></span>
                <span
                    style="font-weight: 600; color: var(--text-dark); text-transform: uppercase; font-size: 13px; letter-spacing: 1px;">Current:
                    {{ session_info.session|title }} Session</span>
            </div>
        </div>

        <!-- Live Auctions Section -->
        {% if live_auctions %}
        <h2
            style="font-family: 'Playfair Display', serif; font-size: 28px; margin-bottom: 25px; color: var(--text-dark); border-bottom: 3px solid var(--primary-green); display: inline-block; padding-bottom: 10px;">
            Live Auctions</h2>
        <div class="auction-grid"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; margin-bottom: 60px;">
            {% for auction in live_auctions %}
            <div class="auction-card"
                style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: transform 0.3s ease;">
                <div class="card-image" style="position: relative; height: 200px;">
                    <img src="{{ auction.display_image }}" alt="{{ auction.commodity }}"
                        style="width: 100%; height: 100%; object-fit: cover;">
                    <span class="badge"
                        style="position: absolute; top: 15px; right: 15px; background: var(--primary-green); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">LIVE</span>
                </div>
                <div class="card-content" style="padding: 20px;">
                    <h3
                        style="font-family: 'Playfair Display', serif; font-size: 20px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ auction.commodity }}</h3>
                    <!-- prettier-ignore -->
                    <p class="location" style="color: #666; font-size: 14px; margin-bottom: 15px;"><i
                            class="fas fa-layer-group"></i> {{ auction.quantity }} {{ auction.unit }}</p>
                    <div class="bid-info-master">
                        <div class="bid-row margin-bottom">
                            <!-- prettier-ignore -->
                            <span class="bid-label-v2">{{ auction.display_label }}</span>
                            <!-- prettier-ignore -->
                            <span class="bid-price-v2">₹{{ auction.display_price }}/{{ auction.unit }}</span>
                        </div>
                        <div class="bid-row">
                            <!-- prettier-ignore -->
                            <span class="bid-label-v2">{{ auction.time_label }}</span>
                            <!-- prettier-ignore -->
                            <span class="bid-time-v2">{{ auction.display_time }}</span>
                        </div>
                    </div>
                    <a href="{% url 'auction_detail' auction.id %}" class="btn btn-primary btn-block"
                        style="border-radius: 10px;">View Details</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Upcoming Evening Auctions (shown during break) -->
        {% if session_info.is_break and upcoming_evening %}
        <h2
            style="font-family: 'Playfair Display', serif; font-size: 28px; margin-bottom: 25px; color: var(--text-dark); border-bottom: 3px solid #f59e0b; display: inline-block; padding-bottom: 10px;">
            Upcoming Evening Session</h2>
        <div class="auction-grid"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; margin-bottom: 60px;">
            {% for auction in upcoming_evening %}
            <div class="auction-card"
                style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: transform 0.3s ease; opacity: 0.9;">
                <div class="card-image" style="position: relative; height: 200px;">
                    <img src="{{ auction.display_image }}" alt="{{ auction.commodity }}"
                        style="width: 100%; height: 100%; object-fit: cover;">
                    <span class="badge"
                        style="position: absolute; top: 15px; right: 15px; background: #f59e0b; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">UPCOMING</span>
                </div>
                <div class="card-content" style="padding: 20px;">
                    <h3
                        style="font-family: 'Playfair Display', serif; font-size: 20px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ auction.commodity }}</h3>
                    <!-- prettier-ignore -->
                    <p class="location" style="color: #666; font-size: 14px; margin-bottom: 15px;"><i
                            class="fas fa-layer-group"></i> {{ auction.quantity }} {{ auction.unit }}</p>
                    <div class="bid-info-master">
                        <div class="bid-row margin-bottom">
                            <!-- prettier-ignore -->
                            <span class="bid-label-v2">{{ auction.display_label }}</span>
                            <!-- prettier-ignore -->
                            <span class="bid-price-v2">₹{{ auction.display_price }}/{{ auction.unit }}</span>
                        </div>
                        <div class="bid-row">
                            <!-- prettier-ignore -->
                            <span class="bid-label-v2">{{ auction.time_label }}</span>
                            <!-- prettier-ignore -->
                            <span class="bid-time-v2">{{ auction.display_time }}</span>
                        </div>
                    </div>
                    <div class="upcoming-actions" style="display: flex; gap: 10px; width: 100%;">
                        {% if not user.is_authenticated or user.user_type == 'BUYER' %}
                            {% if not auction.is_subscribed %}
                            <button
                                class="btn btn-outline notify-btn"
                                onclick="toggleNotify(this)" data-listing-id="{{ auction.id }}"
                                style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px 5px; font-size: 0.9rem; border-radius: 10px;">
                                <i class="far fa-bell" style="margin-right: 5px;"></i> Notify Me
                            </button>
                            {% endif %}
                        {% endif %}
                        <a href="{% url 'auction_detail' auction.id %}" class="btn btn-outline"
                            style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px 5px; font-size: 0.9rem; border-radius: 10px;">
                            <i class="fas fa-eye" style="margin-right: 5px;"></i> View Details
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Ended Auctions -->
        {% if ended_auctions %}
        <h2 style="font-family: 'Playfair Display', serif; font-size: 28px; margin-bottom: 25px; color: #64748b;">
            Recently Ended</h2>
        <div class="auction-grid"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; margin-bottom: 60px;">
            {% for auction in ended_auctions %}
            <div class="auction-card grayscale"
                style="background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); filter: grayscale(1); opacity: 0.7;">
                <div class="card-image" style="position: relative; height: 200px;">
                    <img src="{{ auction.display_image }}" alt="{{ auction.commodity }}"
                        style="width: 100%; height: 100%; object-fit: cover;">
                    <span class="badge"
                        style="position: absolute; top: 15px; right: 15px; background: #64748b; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ENDED</span>
                </div>
                <div class="card-content" style="padding: 20px;">
                    <h3
                        style="font-family: 'Playfair Display', serif; font-size: 20px; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ auction.commodity }}</h3>
                    <!-- prettier-ignore -->
                    <p class="location" style="color: #666; font-size: 14px; margin-bottom: 15px;"><i
                            class="fas fa-layer-group"></i> {{ auction.quantity }} {{ auction.unit }}</p>
                    <div class="bid-info-master">
                        <div class="bid-row margin-bottom">
                            <span class="bid-label-v2">Final Bid</span>
                            <!-- prettier-ignore -->
                            <span class="bid-price-v2" style="color: #666;">₹{{ auction.display_price }}/{{ auction.unit }}</span>
                        </div>
                        <div class="bid-row">
                            <span class="bid-label-v2">Ended At</span>
                            <!-- prettier-ignore -->
                            <span class="bid-time-v2">{{ auction.display_time }}</span>
                        </div>
                    </div>
                    <a href="{% url 'auction_detail' auction.id %}" class="btn btn-outline btn-block"
                        style="border-radius: 10px;">View Details</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- No Auctions Message -->
        {% if not live_auctions and not upcoming_evening and not ended_auctions %}
        <div class="no-auctions"
            style="text-align: center; padding: 60px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-top: 40px;">
            <i class="fas fa-gavel" style="font-size: 60px; color: #e2e8f0; margin-bottom: 20px; display: block;"></i>
            <h3
                style="font-family: 'Playfair Display', serif; font-size: 24px; color: var(--text-dark); margin-bottom: 10px;">
                No Active Auctions</h3>
            <p style="color: #64748b;">There are no auctions available in the current session. Please check back later.
            </p>
            <a href="/" class="btn btn-primary" style="margin-top: 25px; display: inline-block;">Return Home</a>
        </div>
        {% endif %}
    </div>
</section>

<script>
    function toggleNotify(btn) {
        const listingId = btn.dataset.listingId;
        fetch(`/listing/${listingId}/notify/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.status === 403) {
                    alert("Please log in as a Buyer to subscribe or ensure your account type is correct.");
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (!data) return;
                if (data.subscribed) {
                    btn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.location.href = '/login/';
            });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}