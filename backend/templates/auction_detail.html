{% extends "base.html" %}
{% block content %}
<section class="section auction-detail" style="padding: 100px 0 150px 0; background: #f8fafc;">
<div class="container">
<div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 40px; background: white; padding: 40px; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.05);">
<div class="detail-visuals">
<div style="position: relative; border-radius: 20px; overflow: hidden; height: 450px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
<img src="{{ listing.display_image }}" alt="{{ listing.commodity }}" style="width: 100%; height: 100%; object-fit: cover;">
<div style="position: absolute; top: 20px; right: 20px;"><span class="detail-badge">{{ listing.display_label }}</span></div>
</div>
<h2 style="font-family: Playfair Display, serif; font-size: 28px; color: var(--text-dark); margin-bottom: 15px;">Product Description</h2>
<p class="detail-description">{{ listing.clean_description }}</p>

<!-- Seller Details -->
<div style="margin-bottom: 25px; padding: 15px; background: #fffbe6; border-radius: 12px; display: flex; align-items: center; gap: 15px; border: 1px solid #fef3c7;">
    <div style="width: 45px; height: 45px; background: #fff7ed; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #d97706; font-size: 20px;">
        <i class="fas fa-store"></i>
    </div>
    <div>
        <h4 style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 2px;">Sold by</h4>
        <p style="font-size: 16px; color: #1f2937; font-weight: 500; margin: 0;">
            {{ listing.seller.get_full_name|default:listing.seller.email }}
        </p>
    </div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
<div class="detail-info-card"><span class="label-v2" style="display: block; margin-bottom: 5px;">Quantity Available</span><strong class="detail-value">{{ listing.quantity }} {{ listing.unit }}</strong></div>
<div class="detail-info-card"><span class="label-v2" style="display: block; margin-bottom: 5px;">Base Price</span><strong class="detail-value">{{ listing.base_price|floatformat:0 }} / {{ listing.unit }}</strong></div>
</div>
<div class="bid-history" style="margin-top: 20px; padding: 25px; background: #f8fafc; border-radius: 20px; border: 1px solid #e2e8f0;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h3 style="font-family: Playfair Display, serif; font-size: 22px; color: var(--text-dark);">Bid History</h3><span style="font-size: 13px; color: #64748b;">Top 5 Bidders</span></div>
<div style="display: grid; gap: 12px;">{% for bid in bid_history %}<div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #ffffff; border: 1px solid #f1f5f9; border-radius: 12px;"><div style="display: flex; align-items: center; gap: 12px;"><div style="width: 36px; height: 36px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary-green);"><i class="fas fa-user"></i></div><div><div style="font-weight: 600; color: var(--text-dark); font-size: 14px;">{{ bid.buyer.get_full_name|default:bid.buyer.email }}</div><div style="font-size: 12px; color: #94a3b8;">{{ bid.timestamp|date:"M d, H:i" }}</div></div></div><strong style="color: var(--primary-green); font-size: 16px;">{{ bid.amount }}</strong></div>{% empty %}<div style="text-align: center; padding: 30px; background: #ffffff; border-radius: 15px; border: 2px dashed #e2e8f0;"><p style="color: #94a3b8; font-size: 14px;">No bids placed yet. Be the first to bid!</p></div>{% endfor %}</div>
</div>
</div>
<div class="detail-actions">
<div style="background: #ffffff; border: 2px solid #f1f5f9; border-radius: 25px; padding: 35px; position: sticky; top: 120px;">
<h1 style="font-family: Playfair Display, serif; font-size: 36px; color: var(--text-dark); margin-bottom: 10px;">{{ listing.commodity }}</h1>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px;">
                                <i class="fas fa-clock" style="color: var(--primary-green);"></i>
                                <span style="color: #64748b; font-weight: 500;">{{ listing.time_label }}: 
                                    <span style="color: var(--text-dark);">
                                        {% now "Y-m-d" as current_date_str %}
                                        {% if listing.time_label == "Starts At" %}
                                            {% if listing.start_time|date:"Y-m-d" == current_date_str %}
                                                Today, {{ listing.start_time|date:"h:i A" }}
                                            {% else %}
                                                {{ listing.start_time|date:"M d, h:i A" }}
                                            {% endif %}
                                        {% else %}
                                            {{ listing.display_time }}
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
<div class="detail-bid-box"><span class="label-v2" style="display: block; margin-bottom: 8px;">{{ listing.display_label }}</span><div class="bid-price-v2" style="font-size: 48px; letter-spacing: -1px;">{{ listing.display_price }} <span style="font-size: 0.5em; color: #64748b; font-weight: 500;">/ {{ listing.unit }}</span></div></div>
{% if messages %}{% for message in messages %}<div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}" style="margin-bottom: 20px; border-radius: 12px;">{{ message }}</div>{% endfor %}{% endif %}
{% if user.is_authenticated and user.user_type == 'BUYER' %}
    {% if listing.is_break_time %}
    <div style="background: #fff7ed; padding: 25px; border-radius: 15px; border: 1px solid #ffedd5; text-align: center;">
        <i class="fas fa-mug-hot" style="font-size: 30px; color: #ea580c; margin-bottom: 15px;"></i>
        <h3 style="font-family: Playfair Display, serif; font-size: 20px; color: #9a3412; margin-bottom: 10px;">Auction on Break</h3>
        <p style="color: #9a3412; font-size: 15px; line-height: 1.5;">
            The bidding is currently paused for the break session.<br>
            <strong>Resumes at 2:15 PM</strong>
        </p>
    </div>
    {% else %}
    <form action="{% url 'place_bid' listing.id %}" method="POST">{% csrf_token %}
    <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: var(--text-dark);">Enter Your Bid (Per {{ listing.unit }})</label>
        <div style="position: relative;">
            <span style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 20px; font-weight: 600; color: #64748b;">₹</span>
            <input type="number" id="bidInput" name="amount" required step="0.01" min="{{ listing.display_price }}" 
                data-quantity="{{ listing.quantity|stringformat:'f' }}"
                data-current-price="{% if listing.current_highest_bid %}{{ listing.current_highest_bid|stringformat:'f' }}{% else %}{{ listing.base_price|stringformat:'f' }}{% endif %}"
                style="width: 100%; padding: 18px 18px 18px 45px; border: 2px solid #e2e8f0; border-radius: 15px; font-size: 20px; font-weight: 600;" 
                placeholder="{{ listing.display_price|add:1 }}">
        </div>
        
        <!-- Total Price Calculator Display -->
        <div id="totalPriceCalc" style="margin-top: 15px; padding: 15px; background: #f8fafc; border: 1px dashed #94a3b8; border-radius: 12px; display: block;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="totalCalcLabel" style="color: #475569; font-size: 14px; font-weight: 500;">Total Value (Current Price)</span>
                <span id="totalCalcValue" style="color: #334155; font-size: 18px; font-weight: 700;">₹0</span>
            </div>
            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0; opacity: 0.8;">Calculation: Price × Total Quantity</p>
        </div>

        <p style="color: #64748b; font-size: 14px; margin-top: 10px;">
            <i class="fas fa-info-circle"></i> Minimum bid required: <strong>₹{{ listing.display_price }}/{{ listing.unit }}</strong>
        </p>
    </div>
    <button type="submit" class="btn btn-primary btn-block" style="padding: 20px; font-size: 18px; font-weight: 700; border-radius: 15px;">Place Bid Now</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bidInput = document.getElementById('bidInput');
            const totalDisplay = document.getElementById('totalPriceCalc');
            const totalValueSpan = document.getElementById('totalCalcValue');
            const totalLabel = document.getElementById('totalCalcLabel');
            
            if (bidInput && totalDisplay && totalValueSpan) {
                // Get quantity and current price from data attributes
                const rawQty = bidInput.getAttribute('data-quantity');
                const rawCurrentPrice = bidInput.getAttribute('data-current-price');
                const quantity = parseFloat(rawQty);
                const currentPrice = parseFloat(rawCurrentPrice);
                
                console.log("Calculator Initialized. Qty:", quantity, "Base Price:", currentPrice);

                function formatCurrency(amount) {
                    let formatted = "₹" + amount.toFixed(2);
                    try {
                        formatted = amount.toLocaleString('en-IN', {
                            style: 'currency',
                            currency: 'INR',
                            maximumFractionDigits: 2
                        });
                    } catch(e) {
                        console.warn("Locale formatting failed");
                    }
                    return formatted;
                }

                function calculateTotal() {
                    const inputVal = parseFloat(bidInput.value);
                    let priceToUse = 0;
                    let isUserBid = false;

                    if (!isNaN(inputVal) && inputVal > 0) {
                        priceToUse = inputVal;
                        isUserBid = true;
                    } else if (!isNaN(currentPrice)) {
                        priceToUse = currentPrice;
                        isUserBid = false;
                    }

                    if (priceToUse > 0 && !isNaN(quantity)) {
                        const total = priceToUse * quantity;
                        totalValueSpan.textContent = formatCurrency(total);
                        
                        if (isUserBid) {
                             totalLabel.textContent = "Total Payable Amount (Your Bid)";
                             totalLabel.style.color = "#166534";
                             totalValueSpan.style.color = "#15803d";
                             totalDisplay.style.background = "#f0fdf4"; // Greenish for active input
                             totalDisplay.style.borderColor = "#4ade80";
                        } else {
                             totalLabel.textContent = "Total Value (Current Price)";
                             totalLabel.style.color = "#475569";
                             totalValueSpan.style.color = "#334155";
                             totalDisplay.style.background = "#f8fafc"; // Neutral/Greyish for default
                             totalDisplay.style.borderColor = "#94a3b8";
                        }
                        
                        totalDisplay.style.display = 'block';
                    } else {
                        totalDisplay.style.display = 'none';
                    }
                }

                bidInput.addEventListener('input', calculateTotal);
                bidInput.addEventListener('keyup', calculateTotal);
                bidInput.addEventListener('change', calculateTotal);
                
                // Run immediately on load
                calculateTotal();

                // CSRF Protection Enhancement: Refresh token from cookie on interaction
                // This prevents "CSRF Verification Failed" if the page has been open for a long time
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }

                function refreshCsrfToken() {
                    const cookieToken = getCookie('csrftoken');
                    const formTokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                    if (cookieToken && formTokenInput && formTokenInput.value !== cookieToken) {
                        console.log("Refreshing stale CSRF token from cookie");
                        formTokenInput.value = cookieToken;
                    }
                }

                // Refresh on hover/focus of the bid area
                bidInput.addEventListener('focus', refreshCsrfToken);
                bidInput.addEventListener('mouseenter', refreshCsrfToken);
                
                // Also refresh before submit
                const form = document.querySelector('form[action*="place_bid"]');
                if (form) {
                    form.addEventListener('submit', refreshCsrfToken);
                }
            }
        });
    </script>
    {% endif %}
{% elif not user.is_authenticated %}
<a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary btn-block" style="padding: 20px; border-radius: 15px;">Login to Participate</a>
{% else %}
<div style="background: #fffbeb; padding: 20px; border-radius: 15px; border: 1px solid #fde68a;"><p style="color: #92400e; font-size: 15px; text-align: center;"><i class="fas fa-exclamation-triangle"></i> Only registered buyers can place bids.</p></div>
{% endif %}
</div>
</div>
</div>
</div>
</section>
{% endblock %}